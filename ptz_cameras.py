import argparseimport jsonimport reimport socketimport timeimport xmlrpc.clientfrom xmlrpc.server import SimpleXMLRPCServerfrom xmlrpc.server import SimpleXMLRPCRequestHandlerfrom pprint import pprint CAMERA_PORT = 1259PAN_SPEED_MAX = "18"TILT_SPEED_MAX = "14"ON_COMMAND = "8101040002FF"OFF_COMMAND = "8101040003FF"PAN_TILT_COMMAND = "81010602{PAN_SPEED}{TILT_SPEED}0{PAN[0]}0{PAN[1]}0{PAN[2]}0{PAN[3]}0{TILT[0]}0{TILT[1]}0{TILT[2]}0{TILT[3]}FF"PAN_TILT_INQ_COMMAND = "81090612FF"ZOOM_COMMAND = "81010447{ZOOM}FF"ZOOM_INQ_COMMAND = "81090447FF"FOCUS_COMMAND = "810104480{FOCUS[0]}0{FOCUS[1]}0{FOCUS[2]}0{FOCUS[3]}FF"FOCUS_INQ_COMMAND = "81090448FF"##def flush_ptz_data():##    with open('ptz_data.json', 'w') as f:##        f.write(json.dumps(ptz_data, indent=4))####def start_daemon():##    with SimpleXMLRPCServer(('localhost', 8001)) as server:##        server.register_introspection_functions()##        with open('ptz_data.json', 'r') as f:##            ptz_data = json.load(f)####        class ServerFunctions:##            # TODO could actually handle input data##            def get(self, camera, key):##                ##                return ptz_data[camera][key]####            # TODO could actually handle input data##            def set(self, camera, key, value):##                ptz_data[camera][key] = value##                flush_ptz_data()##                return True####        @server.register_function##        def stop_daemon():##            server._BaseServer__shutdown_request = True##        ##        server.register_instance(ServerFunctions())##        server.serve_forever()def get_connection(ip):    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, 0)    s.connect((ip, CAMERA_PORT))    return sdef send_commands(args, camera):    data_server = xmlrpc.client.ServerProxy('http://127.0.0.1:8001')    ip = data_server.get(camera, "ip")    conn = get_connection(ip)    query_results = {}    if args.off:        data = bytes.fromhex(OFF_COMMAND)        conn.send(data)    if args.on:        data = bytes.fromhex(ON_COMMAND)        conn.send(data)    if args.preset:        preset = data_server.get(camera, args.preset)        if preset:            pan_tilt_command = bytes.fromhex(PAN_TILT_COMMAND.format(PAN_SPEED=PAN_SPEED_MAX, TILT_SPEED=TILT_SPEED_MAX, PAN=preset["pan"], TILT=preset["tilt"]).upper())            conn.send(pan_tilt_command)            zoom_command = bytes.fromhex(ZOOM_COMMAND.format(ZOOM=preset["zoom"]).upper())            conn.send(zoom_command)            focus_command = bytes.fromhex(FOCUS_COMMAND.format(FOCUS=preset["focus"]).upper())            conn.send(focus_command)            data_server.set(camera, "current_pos", preset)    if args.query_zoom:        conn.send(bytes.fromhex(ZOOM_INQ_COMMAND))        response = conn.recv(1024).hex().upper()        match = re.match(r"90500(?P<p>.)0(?P<q>.)0(?P<r>.)0(?P<s>.)FF", response)        if match:            zoom_response = match.groupdict()            zoom_value = "{}{}{}{}".format(zoom_response["p"], zoom_response["q"], zoom_response["r"], zoom_response["s"])            query_results["zoom"] = zoom_value    if args.query_pan_tilt:        conn.send(bytes.fromhex(PAN_TILT_INQ_COMMAND))        response = conn.recv(1024).hex().upper()        match = re.match(r"90500(?P<w0>.)0(?P<w1>.)0(?P<w2>.)0(?P<w3>.)0(?P<z0>.)0(?P<z1>.)0(?P<z2>.)0(?P<z3>.)FF", response)        if match:            pan_tilt_response = match.groupdict()            pan_value = "{}{}{}{}".format(pan_tilt_response["w0"], pan_tilt_response["w1"], pan_tilt_response["w2"], pan_tilt_response["w3"])            tilt_value = "{}{}{}{}".format(pan_tilt_response["z0"], pan_tilt_response["z1"], pan_tilt_response["z2"], pan_tilt_response["z3"])            query_results["pan"] = pan_value            query_results["tilt"] = tilt_value    if args.query_focus:        conn.send(bytes.fromhex(FOCUS_INQ_COMMAND))        response = conn.recv(1024).hex().upper()        match = re.match(r"90500(?P<p>.)0(?P<q>.)0(?P<r>.)0(?P<s>.)FF", response)        if match:            focus_response = match.groupdict()            focus_value = "{}{}{}{}".format(focus_response["p"], focus_response["q"], focus_response["r"], focus_response["s"])            query_results["focus"] = focus_value    if args.query_zoom or args.query_pan_tilt or args.query_focus:        print(camera, query_results)        if args.log:            data_server.log({camera: query_results})    conn.close()def process_input(args):    # TODO Check for daemon and launch if doesn't exist or just read data    if args.launch_daemon:        #subprocess.Popen("ptz_cameras.py --launch_daemon", creationflags=subprocess.DETACHED_PROCESS, close_fds=True)        pass            # Run commands for main    if args.main_action:        camera = "main"        send_commands(args, camera)    # Run commands for alt    if args.alt_action:        camera = "alt"        send_commands(args, camera)if __name__ == "__main__":    parser = argparse.ArgumentParser(description='Interact with PTZ cameras')    parser.add_argument('--launch_daemon', dest='launch_daemon', action='store_true', default=False, help='Start the Daemon (This should be done automatically)')    #parser.add_argument('--stop_daemon', dest='stop_daemon', action='store_true', default=False, help='Stop the Daemone (this will occur automatically when cameras are shut off)')    parser.add_argument('--main', dest='main_action', action='store_true', default=False, help='Do these actions to the main camera')    parser.add_argument('--alt', dest='alt_action', action='store_true', default=False, help='Do these actions to the alt camera')    parser.add_argument('--preset', dest='preset', type=str, help='Move Camera to position --preset [value]')    #parser.add_argument('--pan', dest='pan', type=str, help='Set the pan --pan [value]')    #parser.add_argument('--tilt', dest='tilt', type=str, help='Set the tilt --tilt [value]')    #parser.add_argument('--zoom', dest='zoom', type=str, help='Set the zoom --zoom [value]')    parser.add_argument('--off', dest='off', action='store_true', default=False, help='Send off to camera')    parser.add_argument('--on', dest='on', action='store_true', default=False, help='Send on to camera')    parser.add_argument('--query_zoom', dest='query_zoom', action='store_true', default=False, help='Get the current zoom values')    parser.add_argument('--query_pan_tilt', dest='query_pan_tilt', action='store_true', default=False, help='Get the current pan and tilt values')    parser.add_argument('--query_focus', dest='query_focus', action='store_true', default=False, help='Get the current focus values')    parser.add_argument('--log', dest='log', action='store_true', default=False, help='Add to ptz_data')        args = parser.parse_args()    process_input(args)# ptz_cameras.py --main --preset "worship_center"# ptz_cameras.py --main --preset "worship_center_pnp"# ptz_cameras.py --main --preset "pulpit_center"# ptz_cameras.py --main --preset "pulpit_center_pnp"# ptz_cameras.py --main --preset "sermon_center"# ptz_cameras.py --main --preset "sermon_center_pnp"# ptz_cameras.py --main --preset "altar_center"# ptz_cameras.py --main --preset "altar_center_pnp"# ptz_cameras.py --main --query_zoom --query_pan_tilt --query_focus"# ptz_cameras.py --alt --preset "worship_center"# ptz_cameras.py --alt --preset "worship_center_pnp"# ptz_cameras.py --alt --preset "pulpit_center"# ptz_cameras.py --alt --preset "pulpit_center_pnp"# ptz_cameras.py --alt --preset "sermon_center"# ptz_cameras.py --alt --preset "sermon_center_pnp"# ptz_cameras.py --alt --preset "altar_center"# ptz_cameras.py --alt --preset "altar_center_pnp"# ptz_cameras.py --alt --query_zoom --query_pan_tilt --query_focus"